---
title: "BTS Flight Time Regression Results"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float:
      collapsed: true
      smooth_scroll: false
---

<!-- saved from url=(0014)about:internet -->
<!-- This needs to be manually added to the second line of the html -->

# Overview 

Summary of results from models of all reportable flights from 2015 - 2018. 

Two modeling approaches were taken. First, individually modeling each flight segment (origin-destination, O-D) by each carrier (C):

$$
AIRTIME_{C_{O-D}} = \beta1_{C_{O-D}} Year_{C_{O-D}} + \beta2_{C_{O-D}} MONTH_{C_{O-D}} + \beta3_{C_{O-D}}DAY_{C_{O-D}} + \beta4_{C_{O-D}}DEP_{C_{O-D}}
$$

For each carrier, each origin-destination flight segment was modeled as a linear combination of month of year, day of week, and departure time block (hour of day). These are the variables that an air carrier would know when scheduling a flight, and thus what would be available to provide a prediction of estimated flight time for a consumer at the time of booking. Two-way interactions were included. 

Second, individually modeling each flight segment (origin-destination, O-D) across carrier:

$$
AIRTIME_{O-D} = \beta1_{O-D} CARRIER_{O-D} + \beta2_{O-D} YEAR_{O-D} + \beta3_{O-D} MONTH_{O-D} + \beta4_{O-D}DAY_{O-D} + \beta5_{O-D}DEP_{O-D}
$$

This approach differs from the first by including all flights on a particular flight segment regardless of carrier. The carrier-specific effects are then an offset from the overall estimate, with two--way interactions again included. 

<!-- Additional variables to consider could be predictable climatological features (El Nino) or expected airport congestion. -->

## Validation

In order to validate a predictive model, a model has to be fit using one portion of the data, and then applied to a new set of data which was not used in the fitting process. For this project, we are focused on assessing the feasibility for a carrier to report air time for a flight segment at the time of booking. Therefore, we want to know how good the models we fit are at generating air time estimates. We can validate first internally, using a portion of the data from 2015-2018 which was not used in the fitting of the model, as well as externally, applying the models fitted with complete 2015-2018 data to flights in 2019.

- Internal validation: Set aside a stratified random sample of flights within each O-D pair flown by each carrier. Use 80% of the flight data to train the model, and the remaining 20% is set aside to test the model.
- External validation: Use the complete 2015-2018 data to fit the model. Use available flights from 2019 to test the model. 

Currently, only January and February flight data are available for 2019 ([Transtats](https://www.transtats.bts.gov/Tables.asp?DB_ID=120&DB_Name=Airline On-Time Performance Data&DB_Short_Name=On-Time)).  

The most important metric of model goodness-of-fit for this project is how close the model predictions are to the observed air time. We use mean absolute error (MAE) to show how close model predictions are in minutes to observed air times for a given O-D pair. MAE is calculated as follows:

$$
MAE = \frac{ \sum^{n}_{i=1}|\hat{y}_i - y_i | }{n}
$$
For $n$ observations of an O-D pair $i$, where $y_i$ is the observed air time and $\hat{y}_i$ is the predicted flight time. In addition, it is useful to report the coefficient of determination for a model, or $r^2$. Unlike MAE, which is reported in the original unit of minutes of air time, $r^2$ ranges from 0-1 and reflects the proportion of the variation in air time which is explained by the model. For this project, $r^2$ is useful for comparing across models, but MAE is most relevant for the determination of feasibility of flight time reporting. 

## Model summary

Combining the two modeling approaches (O-D within carrier and O-D across carriers) and two validation approaches (internal and external) results in the following combinations of models.

| Model Approach     | Validation Approach | Training Data Set                     | Test Data Set                        | Total Number of Models |
|--------------------|---------------------|---------------------------------------|--------------------------------------|------------------------|
| O-D Within Carrier | Internal            | 2015-2018, 80% of data (17 M flights) | 2015-2018, 20% of data (4 M flights) |     10,372             |
| O-D Within Carrier | 2019                | 2015-2018, 100% of data (21 M flights)| 2019 available data (861,623 flights)|     10,372             |
| O-D Across Carrier | Internal            | 2015-2018, 80% of data (17 M flights) | 2015-2018, 20% of data (4 M flights) |      5,101             |
| O-D Across Carrier | 2019                | 2015-2018, 100% of data (21 M flights)| 2019 available data (861,623 flights)|      5,101             |

The O-D within carrier approach yeilds more total models because multiple carriers fly the same O-D flight segment, for 2,779 of the 5,101 segments. Note that only flight segments which appeared in the 2018 data were included; thus, flight segments which were only flown in 2015 but not in 2018 for example would have been excluded.

<!-- 
summary(table(d_within_Internal$O_D) == 1) # to see how many flight segments are flown by just a single carrier
load(file.path(sharedloc, 'ASQP_2019_validate.RData')); format(nrow(d_19), big.mark = ',') # to look at 2019 data used to date
-->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, message=F)

library(tidyverse)
library(knitr)
library(DT)
library(kableExtra)
library(plotly) # note: masks filter() from dplyr

codeloc = ifelse(grepl('Flynn', normalizePath('~/')),
                   "~/git/Wheels_Up",
                   "~/GitHub/Wheels_Up")
sharedloc = "//vntscex.local/DFS/Projects/PROJ-OR02A2/SDI/BTS_Flight_performance/Data"
resultsloc = "//vntscex.local/DFS/Projects/PROJ-OR02A2/SDI/BTS_Flight_performance/Results"

```

<!--
TODO:
- Summarize n flight segments, MAE and r2 distribution by carrier
- Summarize n flights, MAE and r2 distribution by origin and destination
- R2 by N, R2 by mean flight time, and r2 by sd flight time plots
- Table of most and least predictable flights
-->

# Summary tables 

The following table summarizes the predictability of flights. For the O-D within carrier approach, we report the total number of unique flight segments (origin-destination pairs) modeled, as well as the MAE and $r^2$ for across all flights for that carrier. Not all flight segments could be reliably modeled; for instance, American flew only a single flight between DCA and Atlanta in 2018 (on 2018-12-23, at 9pm). With only a single value for this combination of carrier and origin-destination pair, the current modeling framework does not produce an estimate for this flight segment.

For both approaches (O-D within carrier and O-D across carrier), we summarize the model perfromance by MAE and $r^2$ for each airport. A Tableau dashboard will provide more complete exploration of these results.

```{r prep}

valid_type = c('Internal', '2019')

for(within_carr_valid in valid_type){
  ols_res <- dir(file.path(resultsloc, paste0('1Carrier_Crossyear_Validate_', within_carr_valid)))

  fn = file.path(resultsloc, paste0('1Carrier_Crossyear_Validate_', within_carr_valid, '.csv'))
  if(!file.exists(fn)){
    d <- vector()
    for(i in 1:length(ols_res)){
      dx <- read.csv(file.path(resultsloc, paste0('1Carrier_Crossyear_Validate_', within_carr_valid), ols_res[i]))
      carrier = substr(ols_res[i], 1, 2)
      dx <- data.frame(carrier, dx)
      dx <- dx %>%
        filter(O_D != '') %>%
        mutate(Origin = substr(O_D, 1, 3),
               Destination = substr(O_D, 5, 7))
      
      d <- rbind(d, dx)
    }
    
    assign(paste0('d_within_', within_carr_valid), d)
    
    write.csv(d, file = fn, row.names = F)
    } else {
      assign(paste0('d_within_', within_carr_valid), read.csv(fn))
    }
  }

for(across_carr_valid in valid_type){
  ols_res <- dir(file.path(resultsloc, paste0('1O-D_Crossyear_Validate_', across_carr_valid)))

  fn = file.path(resultsloc, paste0('1O-D_Crossyear_Validate_', across_carr_valid, '.csv'))
  if(!file.exists(fn)){
    d <- read.csv(file.path(resultsloc, paste0('1O-D_Crossyear_Validate_', across_carr_valid), paste0('OLS_Crossyear_1O-D_Validate_', across_carr_valid, '.csv')))
    d <- d %>%
      filter(O_D != '') %>%
      mutate(Origin = substr(O_D, 1, 3),
             Destination = substr(O_D, 5, 7))
  
    assign(paste0('d_across_', across_carr_valid), d)
    
    write.csv(d, file = fn, row.names = F)
    } else {
      assign(paste0('d_across_', across_carr_valid), read.csv(fn))
      }
  }

```

## O-D Within Carrier

### Internal Validation (2015-2018) summarized by carrier

```{r carr_summary1}
d_carrier <- d_within_Internal %>%
  group_by(carrier) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm = T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3),
            #R2_max = round(max(r2[r2 != 1], na.rm = T), 3),
            #Pct_High_R2 = round(100*sum(!is.na(r2) & r2 > 0.5) / length(r2), 2)
            )

kable(d_carrier,
      format.args = list(big.mark = ','),
      caption = "Summary of flight predictability by carrier, 2015-2018 with internal validation. MAE: Mean absolute error in minutes for each flight segment." ) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```

### Internal Validation (2015-2018) summarized by airport

```{r airport_summary1}
d_airport <- d_within_Internal %>%
  group_by(Origin) %>%
  filter(!is.na(MAE)) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm=T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3)
            )

datatable(d_airport,
          rownames = F,
          filter = 'top',
          options = list(order = list(list(3, 'asc')),
                        searchCols = list(NULL, list(search = '200 ... 1000'), NULL, NULL, NULL, NULL, NULL),
                         pageLength = 10),
      caption = "Summary of flight predictability by origin airport, for internal validation 2015-2018. Airports with at least 200 departing flight segments shown by default. Sorted by median MAE, small to large." ) 

```




### External Validation (2019) summarized by carrier

**Note** Need to check to concur that Virgin had no reportable flights in Jan-Feb 2019. 

```{r carr_summary2}
d_carrier <- d_within_2019 %>%
  group_by(carrier) %>%
  filter(!is.na(MAE)) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm = T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3),
            #R2_max = round(max(r2[r2 != 1], na.rm = T), 3),
            #Pct_High_R2 = round(100*sum(!is.na(r2) & r2 > 0.5) / length(r2), 2)
            )

kable(d_carrier,
      format.args = list(big.mark = ','),
      caption = "Summary of flight predictability by carrier, using external validation on flights in 2019. MAE: Mean absolute error in minutes for each flight segment." ) %>% 
  kable_styling(bootstrap_options = c("striped", "hover"))

```


### External Validation (2019) summarized by airport

```{r airport_summary2}
d_airport <- d_within_2019 %>%
  group_by(Origin) %>%
  filter(!is.na(MAE)) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm=T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3)
            )

datatable(d_airport,
          rownames = F,
          filter = 'top',
          options = list(order = list(list(3, 'asc')),
                        searchCols = list(NULL, list(search = '100 ... 1000'), NULL, NULL, NULL, NULL, NULL),
                         pageLength = 10),
      caption = "Summary of flight predictability by origin airport, for external validation on 2019 data. Airports with at least 100 departing flight segments shown by default. Sorted by median MAE, small to large." ) 

```


## O-D Across Carrier

### Internal Validation (2015-2018) summarized by airport

```{r airport_summary3}
d_airport <- d_across_Internal %>%
  group_by(Origin) %>%
  filter(!is.na(MAE)) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm=T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3)
            )

datatable(d_airport,
          rownames = F,
          filter = 'top',
          options = list(order = list(list(3, 'asc')),
                        searchCols = list(NULL, list(search = '100 ... 1000'), NULL, NULL, NULL, NULL, NULL),
                         pageLength = 10),
      caption = "Summary of flight predictability by origin airport, for models across carriers, internal validation 2015-2018. Airports with at least 100 departing flight segments shown by default. Sorted by median MAE, small to large." ) 

```

### External Validation (2019) summarized by airport

```{r airport_summary4}
d_airport <- d_across_2019 %>%
  group_by(Origin) %>%
  filter(!is.na(MAE)) %>%
  summarize(N_flight_segments = n(),
            N_estimated = sum(!is.na(r2)),
            MAE_median = round(median(MAE, na.rm=T), 2),
            MAE_min = round(min(MAE, na.rm = T), 2),
            MAE_max = round(max(MAE, na.rm = T), 2),
            R2_median = round(median(r2, na.rm=T), 3)
            )

datatable(d_airport,
          rownames = F,
          filter = 'top',
          options = list(order = list(list(3, 'asc')),
                        searchCols = list(NULL, list(search = '100 ... 1000'), NULL, NULL, NULL, NULL, NULL),
                         pageLength = 10),
      caption = "Summary of flight predictability by origin airport, for models across carriers, external validation on 2019 data. Airports with at least 100 departing flight segments shown by default. Sorted by median MAE, small to large." ) 

```




