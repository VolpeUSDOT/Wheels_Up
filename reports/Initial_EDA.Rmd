---
title: "FAA Flight Delay EDA"
output: 
  html_document:
    self_contained: true
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---

<!-- saved from url=(0014)about:internet -->
<!-- This needs to be manually added to the second line of the html -->

# Overview 

This document does some initial exploration of the FAA flight delay data. Starting now with 2015 Airline Service Quality Performance ([ASQP](https://aspmhelp.faa.gov/index.php/Airline_Service_Quality_Performance_(ASQP))) data.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, warning=F, message=F)

library(tidyverse)
library(knitr)
library(DT)
library(kableExtra)
library(plotly) # note: masks filter() from dplyr

codeloc = ifelse(grep('Flynn', normalizePath('~/')),
                "~/Documents/git/Wheels_Up",
                "Erika_put_your_path_here/Wheels_Up")
sharedloc = "//vntscex.local/DFS/Projects/PROJ-OR02A2/SDI/BTS_Flight_performance/Data"

avail_data = dir(sharedloc)

if(length(grep('ASQP_2015.RData', dir(sharedloc))) == 0){
  source(file.path(codeloc, 'datacleaning', 'Data_prep.R'))
} else {
  load(file.path(sharedloc, 'ASQP_2015.RData'))
}

```


## Variables in 2015 data

The data frame has `r format(nrow(d_15), big.mark=",")` rows and `r ncol(d_15)` columns.

```{r overview}
overview_df = data.frame(Variables = names(d_15),
                         Class = sapply(d_15, class),
                         N_unique = sapply(d_15, function(x) length(unique(x))),
                         Min_numeric = sapply(d_15, function(x) ifelse(is.numeric(x), min(x, na.rm=T), "")),
                         Max_numeric = sapply(d_15, function(x) ifelse(is.numeric(x), max(x, na.rm=T), "")),
                         Top_factor = sapply(d_15, function(x) ifelse(is.factor(x), names(sort(table(x), dec=T))[1], ""))
                         )

kable(overview_df, 
       row.names = F,
       caption = "Overview of 2015 ASQP data. For factor variables, most frequent value is shown." ) %>% 
    kable_styling(bootstrap_options = c("striped", "hover"))

```

# Notes

Questions (for us to answer after reading the ASQP documentation):

- NULL values for `WHEELS_OFF` or `WHEELS_ON` indicate no value in input data. What reasons might lead to missing values?
- CRS time is the Computerized Reservation System. Should we take CRS time as the scheduled time that a consumer would see 'at booking'?
- What is the WAC code? Appears to be the same as the destination state.
- What is the GRPS code?
- Is distance in miles?

Additional data needs:

- Simple table of lat / long for each airport
- Time zone for departure and arrival airports. We will want this so that we can do our own calculations of time differences; we can generate this given lat longs of each airport if needed.

# Visualization

```{r explore}


delay_summary <- d_15 %>%
  group_by(CARRIER, MONTH, FLIGHT_DATE) %>%
  summarize(n_flights = n(),
            mean_dep_delay = mean(as.numeric(DEP_DELAY_MINS), na.rm=T),
            mean_arr_delay = mean(as.numeric(ARR_DELAY_MINS), na.rm=T),
            sd_dep_delay = sd(as.numeric(DEP_DELAY_MINS), na.rm=T),
            sd_arr_delay = sd(as.numeric(ARR_DELAY_MINS)), na.rm=T)


```

```{r plot1}
p1 <- ggplot(delay_summary) +
 geom_point(aes(x = FLIGHT_DATE, y = mean_arr_delay, color = CARRIER,
                text = paste("N:", n_flights))) +
  ggtitle("Mean arrival delay in minutes by carrier for 2015")

ggplotly(p1)

p2 <- ggplot(delay_summary) +
 geom_point(aes(x = FLIGHT_DATE, y = sd_arr_delay, color = CARRIER,
                text = paste("N:", n_flights))) +
  ggtitle("Standard deviation of arrival delay in minutes by carrier for 2015")

ggplotly(p2)

```

Counts of flights by month, by carrier show some variation. AA in particular merged with US Airways in 2015, so the counts of flights for AA and US reflect that merger.  ([Airline codes here](https://aspmhelp.faa.gov/index.php/ASQP:_Carrier_Codes_and_Names); [AA/US merger](https://en.wikipedia.org/wiki/American_Airlines_Group))

```{r summary2}
kable(table(d_15$CARRIER, d_15$MONTH),
      caption = 'Count of flights by month of 2015, by carrier',
      format.args = list(big.mark = ',')) %>%
    kable_styling(bootstrap_options = c("striped", "hover"))

```
